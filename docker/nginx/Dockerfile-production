# ============================================
# Nginx Dockerfile for EVE-SRP Production
# ============================================
# Minimal Nginx image with only frontend build results
# Base: nginx:1-alpine (~7MB) + Frontend assets (~2-3MB)

# ----------------------------------------------
# Stage 1: Frontend Build
# ----------------------------------------------
FROM node:20.14.0-alpine AS frontend-builder

WORKDIR /build

# Copy package files
COPY frontend/package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy frontend source
COPY frontend/resources ./resources
COPY frontend/webpack.config.js ./

# Build frontend assets
RUN npm run build

# ----------------------------------------------
# Stage 2: Nginx with Static Files
# ----------------------------------------------
FROM nginx:1-alpine

# Remove default nginx static assets
RUN rm -rf /usr/share/nginx/html/*

# Copy frontend build output from stage 1
# Nginx will serve static files from /usr/share/nginx/html/dist
COPY --from=frontend-builder /build/web/dist /usr/share/nginx/html/dist

# Copy nginx configuration
COPY docker/nginx/conf/nginx.production.conf /etc/nginx/conf.d/default.conf

# Create nginx cache directory
RUN mkdir -p /var/cache/nginx/client_temp && \
    chown -R nginx:nginx /var/cache/nginx

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1

# Expose HTTP port
EXPOSE 80

# Start nginx in foreground
CMD ["nginx", "-g", "daemon off;"]
