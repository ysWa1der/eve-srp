# ============================================
# Multi-stage Dockerfile for EVE-SRP Production
# ============================================
# This Dockerfile includes both PHP application and frontend build results
# Optimized for Synology NAS Container Manager deployment

# ----------------------------------------------
# Stage 1: Frontend Build
# ----------------------------------------------
FROM node:20.14.0-alpine AS frontend-builder

WORKDIR /build

# Copy package files
COPY frontend/package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy frontend source
COPY frontend/resources ./resources
COPY frontend/webpack.config.js ./

# Build frontend assets
RUN npm run build

# ----------------------------------------------
# Stage 2: PHP Application
# ----------------------------------------------
FROM php:8.4-fpm-alpine

# Install system dependencies
RUN apk update && apk add --no-cache \
    gmp-dev \
    libpq-dev \
    su-exec \
    netcat-openbsd

# Install PHP extensions
RUN docker-php-ext-install pdo_mysql pdo_pgsql gmp

# Install Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer
ENV COMPOSER_HOME /app/.composer

# Set working directory
WORKDIR /app

# Copy application files
COPY app/ /app/

# Copy frontend build output from stage 1
COPY --from=frontend-builder /build/web/dist /app/web/dist

# Copy entrypoint script
COPY docker/php/entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh

# Create required directories
RUN mkdir -p /app/storage/doctrine \
    /app/storage/compilation_cache \
    /app/storage/logs \
    /app/vendor

# Install composer dependencies (production mode)
RUN COMPOSER_ALLOW_SUPERUSER=1 composer install \
    --no-dev \
    --no-interaction \
    --optimize-autoloader \
    --no-scripts

# Fix permissions for Synology NAS compatibility
RUN chmod -R 777 /app/storage /app/web/dist /app/vendor && \
    chown -R www-data:www-data /app/storage /app/web/dist

# Expose PHP-FPM port
EXPOSE 9000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD nc -z localhost 9000 || exit 1

# Set entrypoint
ENTRYPOINT ["entrypoint.sh"]
CMD ["php-fpm"]
